<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="oncomsm">
<title>Application to Probability of Success Calculation • oncomsm</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.3/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.3/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Application to Probability of Success Calculation">
<meta property="og:description" content="oncomsm">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">oncomsm</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">0.1.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/application-to-probability-of-success.html">Application to Probability of Success Calculation</a>
    <a class="dropdown-item" href="../articles/multi-state-model-for-early-oncology.html">Multi-State Models for Oncology</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/Boehringer-Ingelheim/oncomsm/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Application to Probability of Success Calculation</h1>
                        <h4 data-toc-skip class="author">Kevin Kunzmann</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/Boehringer-Ingelheim/oncomsm/blob/HEAD/vignettes/application-to-probability-of-success.Rmd" class="external-link"><code>vignettes/application-to-probability-of-success.Rmd</code></a></small>
      <div class="d-none name"><code>application-to-probability-of-success.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://boehringer-ingelheim.github.io/oncomsm/">oncomsm</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span>, warn.conflicts <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://future.futureverse.org" class="external-link">future</a></span><span class="op">)</span> <span class="co"># parallel processing</span></span>
<span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="va">multisession</span><span class="op">)</span> <span class="co"># instruct future how to run in parallel</span></span></code></pre></div>
<div class="section level2">
<h2 id="background">Background<a class="anchor" aria-label="anchor" href="#background"></a>
</h2>
<p>For a general introduction to the multi-state approach used throughout this package, see the vignette <em>Multi-state Models for Early Oncology</em>.</p>
<p>Under a fully generative multi-state model, future trial data can be sampled from the prior predictive distribution (if no data is available) or the posterior predictive distribution conditioning on data as it accrues. This can be used to evaluate any decision criterion to determine trial success and thus compute the <em>Probability of Success</em>.</p>
<div class="section level3">
<h3 id="decision-criterion">Decision criterion<a class="anchor" aria-label="anchor" href="#decision-criterion"></a>
</h3>
<p>Assume that the sample size (and follow-up) of the trial and the randomization scheme are fixed upfront. Let further <span class="math inline">\(D_t \in \mathbb{D}\)</span> be the observed (visit) data at time point <span class="math inline">\(t\)</span> after the start of the trial. Let <span class="math inline">\(\tau\)</span> be the stopping time of the trial (all <span class="math inline">\(n\)</span> individuals recruited an minimal follow-up reached) The final decision whether or not the trial is considered a success can then be modeled as a function <span class="math inline">\(\phi: \mathbb{D} \to \{0,1\}\)</span> with</p>
<p><span class="math display">\[\phi(D_\tau)=1 :\Leftrightarrow D_\tau\ \text{is considered a success}\ . \]</span></p>
<p>If we can sample data <span class="math inline">\(D_\tau|\theta\)</span> given a generative model and parameters <span class="math inline">\(\theta\)</span>, we can evaluate the Probability of Success <span class="math display">\[
\operatorname{PoS} = \int \phi(D_\tau) \cdot f(\theta) \operatorname{d}\theta
\]</span> where <span class="math inline">\(f(\theta)\)</span> is a prior over the model parameters using MCMC integration by simulating forward form the predictive distribution. If data <span class="math inline">\(D_t=d_t\)</span> is observed for <span class="math inline">\(t\leq\tau\)</span>, one can update PoS using Bayes Theorem <span class="math display">\[
\operatorname{PoS}\,|\, (D_t=d_t \ ) = \int \phi(D_\tau\,|\,D_t=d_t) \cdot f(\theta\,|\,D_t=d_t) \operatorname{d}\theta \ .
\]</span></p>
<p>Examples for such decision rules could be …</p>
<ol style="list-style-type: decimal">
<li>a quantile of the posterior distribution of the response rate being above a certain relevance threshold,</li>
<li>a quantile of the posterior distribution of the PFS6 rate being above a certain relevance threshold,</li>
<li>a quantile of the posterior distribution of PFS being above a certain threshold,</li>
<li>or a combination of the above.</li>
</ol>
</div>
</div>
<div class="section level2">
<h2 id="example">Example<a class="anchor" aria-label="anchor" href="#example"></a>
</h2>
<div class="section level3">
<h3 id="prior-specification">Prior specification<a class="anchor" aria-label="anchor" href="#prior-specification"></a>
</h3>
<p>Assume the following prior for the multi-state model .</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mdl</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/srp_model.html">create_srp_model</a></span><span class="op">(</span></span>
<span>    <span class="co"># names of the arms/groups</span></span>
<span>    group_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"C"</span><span class="op">)</span>,</span>
<span>    <span class="co"># per-group logodds of response|stable</span></span>
<span>    logodds_mean <span class="op">=</span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="../reference/logodds.html">logodds</a></span><span class="op">(</span><span class="fl">.20</span><span class="op">)</span>, <span class="fu"><a href="../reference/logodds.html">logodds</a></span><span class="op">(</span><span class="fl">.3</span><span class="op">)</span>, <span class="fu"><a href="../reference/logodds.html">logodds</a></span><span class="op">(</span><span class="fl">.3</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    logodds_sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">.5</span>, <span class="fl">.5</span>, <span class="fl">.5</span><span class="op">)</span>,</span>
<span>    <span class="co"># m[i,j] is the median time to next event for group i and transition j</span></span>
<span>    median_time_to_next_event <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      <span class="fl">3</span>, <span class="fl">2</span>, <span class="fl">6</span>,</span>
<span>      <span class="fl">2</span>, <span class="fl">8</span>, <span class="fl">9</span>,</span>
<span>      <span class="fl">2</span>, <span class="fl">6</span>, <span class="fl">24</span> </span>
<span>    <span class="op">)</span>, byrow <span class="op">=</span> <span class="cn">TRUE</span>,  nrow <span class="op">=</span> <span class="fl">3</span>, ncol <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>,</span>
<span>    <span class="co"># fixed standard deviation of the prior for all median times</span></span>
<span>    median_time_to_next_event_sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span> </span>
<span>      <span class="fl">1</span>, byrow <span class="op">=</span> <span class="cn">TRUE</span>,  nrow <span class="op">=</span> <span class="fl">3</span>, ncol <span class="op">=</span> <span class="fl">3</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="co"># uniform prior over the shape parameter, difficult to identify, </span></span>
<span>    <span class="co"># better keep it tight to avoid issues with the sampler</span></span>
<span>    shape_min <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span> </span>
<span>      <span class="fl">.75</span>, byrow <span class="op">=</span> <span class="cn">TRUE</span>,  nrow <span class="op">=</span> <span class="fl">3</span>, ncol <span class="op">=</span> <span class="fl">3</span></span>
<span>    <span class="op">)</span>,</span>
<span>    shape_max <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span> </span>
<span>      <span class="fl">2</span>, byrow <span class="op">=</span> <span class="cn">TRUE</span>,  nrow <span class="op">=</span> <span class="fl">3</span>, ncol <span class="op">=</span> <span class="fl">3</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="co"># the visit interval</span></span>
<span>    visit_spacing <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.2</span>, <span class="fl">1.2</span>, <span class="fl">1.2</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>We can now sample from the prior and visualize it.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">smpl_prior</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sample_prior.html">sample_prior</a></span><span class="op">(</span><span class="va">mdl</span>, warmup <span class="op">=</span> <span class="fl">500</span>, nsim <span class="op">=</span> <span class="fl">2000</span>, seed <span class="op">=</span> <span class="fl">6835L</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mdl</span>, dt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">36</span><span class="op">)</span>, sample <span class="op">=</span> <span class="va">smpl_prior</span><span class="op">)</span></span></code></pre></div>
<p><img src="application-to-probability-of-success_files/figure-html/sample-from-prios-1.png" width="672" style="display: block; margin: auto;"></p>
<p>The induced prior over PFS rates at 3, 6, 12, and 18 months is</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tbl_pfs_rates</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sample_pfs_rate.html">sample_pfs_rate</a></span><span class="op">(</span><span class="va">mdl</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">6</span>, <span class="fl">12</span>, <span class="fl">18</span><span class="op">)</span>, sample <span class="op">=</span> <span class="va">smpl_prior</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>t <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">t</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">tbl_pfs_rates</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html" class="external-link">geom_boxplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">t</span>, y <span class="op">=</span> <span class="va">pfs</span>, color <span class="op">=</span> <span class="va">group_id</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_colour_discrete.html" class="external-link">scale_color_discrete</a></span><span class="op">(</span><span class="st">""</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"t"</span>, y <span class="op">=</span> <span class="st">"Pr[no death or progression before t]"</span><span class="op">)</span></span></code></pre></div>
<p><img src="application-to-probability-of-success_files/figure-html/pfsx-rates-1.png" width="672" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="definition-of-success-criterion">Definition of success criterion<a class="anchor" aria-label="anchor" href="#definition-of-success-criterion"></a>
</h3>
<p>Let us consider two success criteria per arm:</p>
<ol style="list-style-type: decimal">
<li><span class="math inline">\(\phi_1^i(D_\tau) = 0.25 \ \text{posterior quantile of response is greater than} \ 0.3\)</span></li>
<li><span class="math inline">\(\phi_2^i(D_\tau) = 0.25 \ \text{posterior quantile of the PFS12 rate is greater than} \ 0.5\)</span></li>
</ol>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># the simulation number is only chosen so small for demonstration purposes</span></span>
<span><span class="co"># we compute both phi_1 and phi_2 jointly to reuse the same posterior sample</span></span>
<span><span class="va">eval_phi</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">prob</span> <span class="op">=</span> <span class="fl">0.25</span>, <span class="va">nsim</span> <span class="op">=</span> <span class="fl">250</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">smpl</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sample_posterior.html">sample_posterior</a></span><span class="op">(</span><span class="va">mdl</span>, data <span class="op">=</span> <span class="va">data</span>, seed <span class="op">=</span> <span class="fl">38497</span>, warmup <span class="op">=</span> <span class="fl">150L</span>, nsim <span class="op">=</span> <span class="va">nsim</span><span class="op">)</span></span>
<span>  <span class="va">mtx_p</span> <span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">smpl</span>, <span class="st">"p"</span><span class="op">)</span><span class="op">$</span><span class="va">p</span></span>
<span>  <span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">mtx_p</span>, <span class="fl">2</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">.25</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sample_pfs_rate.html">sample_pfs_rate</a></span><span class="op">(</span><span class="va">mdl</span>, <span class="fl">12</span>, <span class="va">smpl</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">group_id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>pfs12 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">pfs</span>, <span class="fl">.25</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>      p <span class="op">=</span> <span class="va">p</span>,</span>
<span>      phi_1 <span class="op">=</span> <span class="va">p</span> <span class="op">&gt;=</span> <span class="fl">0.3</span>,</span>
<span>      phi_2 <span class="op">=</span> <span class="va">pfs12</span> <span class="op">&gt;=</span> <span class="fl">0.5</span></span>
<span>    <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">group_id</span>, <span class="va">phi_1</span>, <span class="va">phi_2</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tbl_prior_predictive</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sample_predictive.html">sample_predictive</a></span><span class="op">(</span></span>
<span>    <span class="va">mdl</span>,</span>
<span>    n_per_group <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">30L</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>    sample <span class="op">=</span> <span class="va">smpl_prior</span>,</span>
<span>    nsim <span class="op">=</span> <span class="fl">100L</span>, <span class="co"># same, here, only for demonstration purposes</span></span>
<span>    seed <span class="op">=</span> <span class="fl">34930L</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">iter</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html" class="external-link">nest</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="va">multisession</span><span class="op">)</span> <span class="co"># instruct future how to run in parallel</span></span>
<span></span>
<span><span class="co"># it is a good idea to cache long running simulation ;)</span></span>
<span><span class="va">tbl_results</span> <span class="op">&lt;-</span> <span class="fu">xfun</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/xfun/man/cache_rds.html" class="external-link">cache_rds</a></span><span class="op">(</span><span class="op">{</span> </span>
<span>  </span>
<span>  <span class="va">tbl_prior_predictive</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>      res <span class="op">=</span> <span class="fu">furrr</span><span class="fu">::</span><span class="fu"><a href="https://furrr.futureverse.org/reference/future_map.html" class="external-link">future_map</a></span><span class="op">(</span></span>
<span>        <span class="va">data</span>, <span class="va">eval_phi</span>,</span>
<span>        .options <span class="op">=</span> <span class="fu">furrr</span><span class="fu">::</span><span class="fu"><a href="https://furrr.futureverse.org/reference/furrr_options.html" class="external-link">furrr_options</a></span><span class="op">(</span>seed <span class="op">=</span> <span class="cn">TRUE</span>, scheduling <span class="op">=</span> <span class="fl">5L</span><span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">data</span><span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span>, dir <span class="op">=</span> <span class="st">".cache/"</span>, file <span class="op">=</span> <span class="st">"sim_results.rds"</span><span class="op">)</span> <span class="co"># end caching</span></span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tbl_results</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html" class="external-link">unnest</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">group_id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span></span>
<span>    pos_phi_1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">phi_1</span><span class="op">)</span>,</span>
<span>    pos_phi_2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">phi_2</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 3 × 3</span></span></span>
<span><span class="co">#&gt;   group_id pos_phi_1 pos_phi_2</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> A             0.04      0   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> B             0.21      0   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> C             0.35      0.01</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="advanced-decision-boundaries-connection-with-bhmbasket">Advanced decision boundaries: connection with bhmbasket<a class="anchor" aria-label="anchor" href="#advanced-decision-boundaries-connection-with-bhmbasket"></a>
</h3>
<p>The <code>bhmbasket</code> package implements dynamic borrowing between arms in basket trials via Bayesian hierarchical models (BHMs). Here, we demonstrate how the prior predictive sample generated earlier can be used in conjunction with such a shrinkage estimator to compute PoS for a decision based on a BHM. We use the “Berry” type model for analysis of the response data and use a posterior <span class="math inline">\(0.25\)</span> quantile of the response rate above <span class="math inline">\(0.3\)</span> to declare success (<span class="math inline">\(\phi_3^i\)</span>).</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prms_berry</span> <span class="op">&lt;-</span> <span class="fu">bhmbasket</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/bhmbasket/man/setPriorParametersBerry.html" class="external-link">setPriorParametersBerry</a></span><span class="op">(</span></span>
<span>  mu_mean   <span class="op">=</span> <span class="fu">bhmbasket</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/bhmbasket/man/logit.html" class="external-link">logit</a></span><span class="op">(</span><span class="fl">0.25</span><span class="op">)</span>,</span>
<span>  mu_sd     <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  tau_scale <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">data_to_bhmbasket_trial</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">group_id</span>, <span class="va">subject_id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>responder <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="va">to</span> <span class="op">==</span> <span class="st">"response"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>r <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">responder</span><span class="op">)</span>, n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="op">{</span><span class="fu">bhmbasket</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/bhmbasket/man/createTrial.html" class="external-link">createTrial</a></span><span class="op">(</span><span class="va">.</span><span class="op">$</span><span class="va">n</span>, <span class="va">.</span><span class="op">$</span><span class="va">r</span><span class="op">)</span><span class="op">}</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">eval_phi_3</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">nsim</span> <span class="op">=</span> <span class="fl">250</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">prob</span> <span class="op">=</span> <span class="fl">0.25</span> <span class="co"># needs to be hard coded</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">2340239L</span><span class="op">)</span></span>
<span>  <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressMessages</a></span><span class="op">(</span><span class="fu">bhmbasket</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/bhmbasket/man/performAnalyses.html" class="external-link">performAnalyses</a></span><span class="op">(</span></span>
<span>      scenario_list         <span class="op">=</span> <span class="fu">data_to_bhmbasket_trial</span><span class="op">(</span><span class="va">data</span><span class="op">)</span>,</span>
<span>      method_names          <span class="op">=</span> <span class="st">"berry"</span>,</span>
<span>      evidence_levels       <span class="op">=</span> <span class="fl">1</span> <span class="op">-</span> <span class="va">prob</span>,</span>
<span>      prior_parameters_list <span class="op">=</span> <span class="va">prms_berry</span>,</span>
<span>      target_rates          <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">.2</span>, <span class="fl">.3</span>, <span class="fl">.3</span><span class="op">)</span>,</span>
<span>      n_mcmc_iterations     <span class="op">=</span> <span class="va">nsim</span>,</span>
<span>      verbose               <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>    <span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>    group_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">mdl</span>, <span class="st">"group_id"</span><span class="op">)</span>,</span>
<span>    phi_3 <span class="op">=</span> <span class="va">res</span><span class="op">$</span><span class="va">scenario_1</span><span class="op">$</span><span class="va">quantiles_list</span><span class="op">$</span><span class="va">berry</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">5</span>, <span class="fl">2</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span> <span class="op">&gt;=</span> <span class="fl">.3</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># it is a good idea to cache long running simulation ;)</span></span>
<span><span class="va">tbl_results_bhmbasket</span> <span class="op">&lt;-</span> <span class="fu">xfun</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/xfun/man/cache_rds.html" class="external-link">cache_rds</a></span><span class="op">(</span><span class="op">{</span> </span>
<span>  </span>
<span>  <span class="va">tbl_prior_predictive</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>      res <span class="op">=</span> <span class="fu">furrr</span><span class="fu">::</span><span class="fu"><a href="https://furrr.futureverse.org/reference/future_map.html" class="external-link">future_map</a></span><span class="op">(</span></span>
<span>        <span class="va">data</span>, <span class="va">eval_phi_3</span>,</span>
<span>        .options <span class="op">=</span> <span class="fu">furrr</span><span class="fu">::</span><span class="fu"><a href="https://furrr.futureverse.org/reference/furrr_options.html" class="external-link">furrr_options</a></span><span class="op">(</span>seed <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">data</span><span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span>, dir <span class="op">=</span> <span class="st">".cache/"</span>, file <span class="op">=</span> <span class="st">"sim_results_bhmbasket.rds"</span><span class="op">)</span> <span class="co"># end caching</span></span></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tbl_results_bhmbasket</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html" class="external-link">unnest</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">group_id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span></span>
<span>    pos_phi_3 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">phi_3</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span></span>
<span>    <span class="va">tbl_results</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>      <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html" class="external-link">unnest</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">group_id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span></span>
<span>        pos_phi_1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">phi_1</span><span class="op">)</span>,</span>
<span>        pos_phi_2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">phi_2</span><span class="op">)</span></span>
<span>      <span class="op">)</span>, </span>
<span>    by <span class="op">=</span> <span class="st">"group_id"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 3 × 4</span></span></span>
<span><span class="co">#&gt;   group_id pos_phi_3 pos_phi_1 pos_phi_2</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> A             0.06      0.04      0   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> B             0.22      0.21      0   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> C             0.31      0.35      0.01</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="computing-dynamic-probability-of-success">Computing dynamic Probability of Success<a class="anchor" aria-label="anchor" href="#computing-dynamic-probability-of-success"></a>
</h2>
<p>The Bayesian framework has two distinct advantages when applied in an early setting.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">recruitment_rate_overall</span> <span class="op">&lt;-</span> <span class="fl">3</span></span>
<span><span class="va">tbl_interim</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sample_predictive.html">sample_predictive</a></span><span class="op">(</span></span>
<span>    <span class="va">mdl</span>, </span>
<span>    sample <span class="op">=</span> <span class="va">smpl_prior</span>,</span>
<span>    n_per_group <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">30L</span>, <span class="fl">30L</span><span class="op">)</span>, </span>
<span>    nsim <span class="op">=</span> <span class="fl">250</span>, </span>
<span>    seed <span class="op">=</span> <span class="fl">3423423</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">iter</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">t_sot</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="op">{</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span></span>
<span>    <span class="va">.</span>,</span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">.</span>, <span class="va">subject_id</span>, <span class="va">group_id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="co"># permute groups</span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>        t_sot <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html" class="external-link">rexp</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span>, rate <span class="op">=</span> <span class="va">recruitment_rate_overall</span><span class="op">)</span><span class="op">)</span>, <span class="co"># poisson recruitment process</span></span>
<span>      <span class="op">)</span>,</span>
<span>    by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"subject_id"</span>, <span class="st">"group_id"</span><span class="op">)</span></span>
<span>  <span class="op">)</span><span class="op">}</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    t_min <span class="op">=</span> <span class="va">t_min</span> <span class="op">+</span> <span class="va">t_sot</span>,</span>
<span>    t_max <span class="op">=</span> <span class="va">t_max</span> <span class="op">+</span> <span class="va">t_sot</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="../reference/mstate_to_visits.html">mstate_to_visits</a></span><span class="op">(</span><span class="va">mdl</span>, <span class="va">.</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">t</span> <span class="op">&lt;=</span> <span class="fl">10</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="../reference/visits_to_mstate.html">visits_to_mstate</a></span><span class="op">(</span></span>
<span>    start_state <span class="op">=</span> <span class="st">"stable"</span>, </span>
<span>    absorbing_states <span class="op">=</span> <span class="st">"progression"</span>, </span>
<span>    now <span class="op">=</span> <span class="fl">10</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; 'mstate_to_visits.srp_model' is experimental</span></span>
<span></span>
<span><span class="va">tbl_interim_sample_sizes</span> <span class="op">&lt;-</span> <span class="va">tbl_interim</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">group_id</span>, <span class="va">subject_id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">group_id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">smpl_posterior</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sample_posterior.html">sample_posterior</a></span><span class="op">(</span></span>
<span>  <span class="va">mdl</span>, </span>
<span>  <span class="va">tbl_interim</span>, </span>
<span>  nsim <span class="op">=</span> <span class="fl">2000</span>, warmup <span class="op">=</span> <span class="fl">250</span>, seed <span class="op">=</span> <span class="fl">76947</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">tbl_to_be_recruited</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>    group_id <span class="op">=</span> <span class="va">tbl_interim_sample_sizes</span><span class="op">$</span><span class="va">group_id</span>,</span>
<span>    n_to_be_recruited <span class="op">=</span> <span class="fl">30</span> <span class="op">-</span> <span class="va">tbl_interim_sample_sizes</span><span class="op">$</span><span class="va">n</span>  </span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    tmp <span class="op">=</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span></span>
<span>      <span class="va">n_to_be_recruited</span>, </span>
<span>      <span class="op">~</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>        <span class="co"># use unique identifiers to avoid clashing between groups</span></span>
<span>        subject_id <span class="op">=</span> <span class="fu">uuid</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/uuid/man/UUIDgenerate.html" class="external-link">UUIDgenerate</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">.</span><span class="op">)</span>,</span>
<span>        <span class="co"># sample recruitment times per group using half the overall </span></span>
<span>        <span class="co"># recruitment rate</span></span>
<span>        t_sot <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html" class="external-link">rexp</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">.</span>, rate <span class="op">=</span> <span class="va">recruitment_rate_overall</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">n_to_be_recruited</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html" class="external-link">unnest</a></span><span class="op">(</span><span class="va">tmp</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="co"># add information on starting state etc to expand to full mstate table</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    from <span class="op">=</span> <span class="st">"stable"</span>,</span>
<span>    to <span class="op">=</span> <span class="cn">NA_character_</span>,</span>
<span>    t_min <span class="op">=</span> <span class="va">t_sot</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="fl">30</span>, <span class="co"># preclude events on the day of recruitment</span></span>
<span>    t_max <span class="op">=</span> <span class="cn">Inf</span> <span class="co"># right censored</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">tbl_mstate_interim_forward</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">tbl_interim</span>, <span class="va">tbl_to_be_recruited</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tbl_posterior_predictive</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/impute_predictive.html">impute_predictive</a></span><span class="op">(</span></span>
<span>    <span class="va">mdl</span>,</span>
<span>    data <span class="op">=</span> <span class="va">tbl_mstate_interim_forward</span>, </span>
<span>    sample <span class="op">=</span> <span class="va">smpl_posterior</span>,</span>
<span>    nsim <span class="op">=</span> <span class="fl">100</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">tbl_posterior_predictive</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 7,807 × 8</span></span></span>
<span><span class="co">#&gt;    subject_id                       group…¹ from  to     t_min t_max t_sot  iter</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                            <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> 2fe5c666-b261-41fb-932f-7077f72… B       stab… prog… 14.7   15.9  0.231     1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> 2fe5c666-b261-41fb-932f-7077f72… B       stab… prog…  0.264  1.46 0.231     2</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> 2fe5c666-b261-41fb-932f-7077f72… B       stab… prog… 11.1   12.3  0.231     3</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> 2fe5c666-b261-41fb-932f-7077f72… B       stab… resp…  1.46   2.66 0.231     4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> 2fe5c666-b261-41fb-932f-7077f72… B       resp… prog… 11.1   12.3  0.231     4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> 2fe5c666-b261-41fb-932f-7077f72… B       stab… resp…  0.264  1.46 0.231     5</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> 2fe5c666-b261-41fb-932f-7077f72… B       resp… prog…  7.46   8.66 0.231     5</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> 2fe5c666-b261-41fb-932f-7077f72… B       stab… prog…  3.86   5.06 0.231     6</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> 2fe5c666-b261-41fb-932f-7077f72… B       stab… prog…  5.06   6.26 0.231     7</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> 2fe5c666-b261-41fb-932f-7077f72… B       stab… prog… 15.9   17.1  0.231     8</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># … with 7,797 more rows, and abbreviated variable name ¹​group_id</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ Use `print(n = ...)` to see more rows</span></span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Kevin Kunzmann.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
